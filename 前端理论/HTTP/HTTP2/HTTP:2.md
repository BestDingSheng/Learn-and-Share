## HTTP/2

HTTP/2基于Google工作组提出的SPDY协议实现的一种协议标准，SPDY并不是HTTP/1.1的替代品，而是作为HTTP/1.1的增强出现的。HTTP/2将许多SPDY中制定的标准添加到了超文本传输协议的标准当中。HTTP/2的主要改进为：二进制分帧、首部压缩、服务器推送以及多路复用。

HTTP/2的最大特点是向下兼容性，其不会改变以前版本的协议的包结构，各种语义、状态码、首部、URI等，而是在网络层和传输层之间进行修改，将这些性能的提升对HTTP的使用人员透明，我们只能感受到HTTP性能的提升，但是不需要额外做太多工作来获得这些提升。

### 二进制分帧

HTTP协议的报文分为两个主要部分：Header和Data，这两个部分被介于应用层和传输层之间的一个二进制分帧层，分别包装为两个帧，这两个帧又会被二进制编码，分为更小的二进制编码帧，由于所有的HTTP/2的通信内容都会被放在同一个TCP连接中，所有这些帧可以被打乱顺序来进行发送，到了目的地之后再被重新组装成一个完整的HTTP报文。

由于只使用一个TCP连接，所以不会发生之前版本的HTTP的TCP慢启动，略过了TCP进行自我调谐的过程，这样降低了HTTP连接的延迟。

### 首部压缩

HTTP/2参考了SPDY一些标准，其中就有首部压缩这一点，原来的HTTP协议每次通信都会发送一个很长的首部信息，很多请求甚至包含20多个首部字段，这些首部字段会占用很大的带宽，并且还好花费时间处理，并且之前的HTTP对于首部完全没有进行压缩，SPDY使用deflate算法对其进行压缩，而HTTP/2设计了HPACK算法进行首部压缩。

HPACK设计了一个静态索引表和动态索引表，静态索引表中存储了常用的HTTP首部信息，这样，客户端和服务器之间的通信首部可以使用比较短的索引来表示。静态索引表是针对全局的。

而由于HTTP/2在每对通信对象中是复用一个TCP连接的，所以对于每个连接还有一个动态索引表。当出现了一个不在静态表中的首部时，会将这个首部置入动态表，这样下次如果需要再使用这个首部的话，就可以直接使用动态表的索引了。

客户端和服务器都会维护这个索引表，并且共同地进行渐进更新，保持两个表的一致性。这样就可以将原本很占资源的首部进行最大化的压缩了。

### TCP复用

*TCP的性能瓶颈在于低延迟而不是高带宽。*

由于HTTP的突发性，每次建立TCP连接时候的握手以及窗口慢启动会导致HTTP性能的下降。HTTP/2将HTTP协议通信的基本单位缩小成了一个一个的二进制帧，这些帧在一个TCP连接上双向传递消息，小报文，多资源的传输方法提高了HTTP的效率，也有效地防止了因为TCP连接数较多而造成的网络拥塞。

由于是分帧并且乱序发送，在另外一端进行重组，所以请求和响应都可以进行并行的交错处理，也就是不再会出现只能从一个域名下并行4个或者并行8个的情况。请求的所有资源可以都来自于一个域名下面，并且这些资源请求时并行进行的。

### 请求优先级

由于是完全的并行交错连接，所以基本所有资源的请求都是一致的进度，这样也会导致一些重要的CSS和JS和不是那么重要的图片内容有交叉，但是其实我们需要早点完成CSS和JS的加载，这样可以让页面尽快渲染出来，给用户一个响应。

HTTP/2可以设置资源的优先级，来控制资源的加载顺序。

### 服务器推送

类似于WebSocket的推送功能，比如服务器可以在客户端请求了一个HTML页面的时候，将该页面所需要的所有资源全部发送给客户端，这样客户端就不需要等待解析HTML的时候再去进行资源的请求了。

### conclusion

上面的这些优化操作可以让之前的web优化变得可有可无，比如sprite picture，多站点资源请求，内嵌图片等优化方法都没有什么太大的价值了。