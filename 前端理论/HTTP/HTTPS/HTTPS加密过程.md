## HTTPS加密过程

HTTP协议如果不依赖外部加密的话，那么在整个传输过程中都是使用明文的。由于HTTP是一个无状态的协议，所以在通信的过程中可能会发生报文被篡改、伪装通信方这种问题的出现。为了防止这些问题，需要对于HTTP添加加密和认证的机制，称为HTTPS。

### SSL

SSL(Secure Socket Layer)，安全套接字层，是介于应用层和传输层的一套加密方法，SSL层和HTTP的结合叫做HTTPS。

### 相互交换密钥的公钥加密技术

SSL采用公钥加密的方法，也就是使用非对称加密算法的公钥对于消息进行加密，然后使用私钥解密之后就可以查看原来的消息内容了。

#### 对称加密技术

由于客户端和服务器都持有一样的密钥进行加密和解密，一旦密钥泄露，那么攻击者就可以很方便的对于所有的加密结果进行破解，这样安全性就不复存在了。

而且，如果采用对称密钥加密的话，那么如何安全地将密钥发送给另外一端是一个需要研究的问题。在网路上直接进行密钥的转发是很不靠谱的，因为一旦通信被监听，那么密钥就会直接泄露给攻击者，并且客户端收到的密钥还要安全的进行保管，防止被攻击者获取。

并且这是一个悖论，如果假设密钥能够安全地发给对象，那么为什么还要多此一举，直接发送消息就可以了。

#### 非对称加密技术

非对称加密会使用公钥进行加密，使用私钥进行解密，这样公钥可以随便发送，对方使用公钥加密之后，由于私钥只存放在服务器端，所以只需要保证服务器端的安全即可，服务器端可以使用自己的私钥对于加密报文进行解密。

#### HTTPS采用混合加密机制

由于非对称加密算法的效率比对称加密算法的效率要低很对，所以如果在建立连接的阶段使用非对称加密算法来发送对称加密算法的密钥，然后在通信阶段使用对称加密密钥来进行报文的加密，可以在安全性和效率中找一个折中，也就是效费比最高的方法。

### 证明公钥正确性的证书

非对称的公钥在传送过程中也有被替换掉的风险，也就是一端无法验证自己收到的公钥是由另外一端发出的公钥。

为了解决这个问题，数字证书认证机构CA（Certificate Authority）颁发的数字证书会对相应的公钥进行验证，来确保密钥和域名是具有一一对应关系的。
数字证书认证机构是一个客户端和服务端都可以信赖的第三方认证机构。

1. 首先服务器端的工作人员会找到CA来申请公钥证书。数字证书认证机构对于申请者的资质进行认证之后，会用自己的私钥对于服务器端的公钥进行数字签名，然后将签名对应的公钥和签名的证书绑定到一起。
2. 这个公钥证书会由服务器发送给客户端。
3. 客户端通过安装浏览器时候植入的CA机构的公钥来对证书的签名进行认证，这样可以确定：证书是由可靠的CA颁发的，服务器的公钥是可以信赖的。
4. 取出证书中的公钥，使用公钥对报文进行加密，然后发送给服务器端。
5. 服务器端使用对应的私钥对报文进行解密。

#### 用以确认客户端的客户端证书

HTTPS中还可以使用客户端证书，用客户端证书来进行客户端认证，证明服务器正在通信的对方始终是预料之内的客户端。客户端证书的成本很高，并且需要让使用者都进行安装，目前这种安全认证方式大部分都用于能够支撑客户端证书支出费用的业务，比如银行的网上银行业务，可以来确定用户的终端是否有权限，是对于账号密码的二次验证。

### HTTPS安全通信机制

#### 握手阶段

1. 客户端向服务端发送一个ClientHello报文
2. 服务端向客户端发送一个ServerHello报文、然后发送公钥证书、然后ServerHelloDone

#### 密钥交换

3. 客户端发送Client Key Exchange报文，该报文使用客户端从证书中获取的密钥进行加密。
4. 客户端发送Change Cipher Spec报文，确定加密方式。
5. 客户端发送Finished报文，握手的成功与否取决于服务端对于报文的解密是否正确。
6. 服务端发送Change Cipher Spec报文。
7. 服务端发送Finished报文。

#### 数据传输

8. 这时候已经建立了SSL连接，可以开始HTTP请求了。

#### 断开连接

9. 客户端发送close_notify报文，来表示断开两端的连接。

### HTTPS的局限

HTTPS的证书支出需要考虑在内，并且由于需要先进行握手才能发送消息，所以延迟也很大，而且在使用HTTPS的时候，客户端和服务器的加解密操作很非常占用CPU和内存资源。