## 渲染性能

### 动画

当对于页面设置动画的时候，需要考虑到设备的屏幕刷新率，一般的设备的屏幕刷新率基本保持在60帧，也就是1秒刷新60次，*动画如果要保证流畅，则需要浏览器的渲染动画也保持在这样的一个速度，也就是留给每次动画触发的时候的渲染时间至多不超过`1s / 60 = 16.6ms`，*但是由于浏览器除了渲染，还有一些其他的工作要做，所以留给渲染的时间差不多只有10毫秒左右，这样才能让用户感觉不到动画的抖动或者卡顿。

1. 一般实现动画的方式可能是通过JavaScript来修改样式来达到的。
2. 或者是通过直接修改CSS达到的，`@keyframes & animation`动画。
3. 在浏览器得到了样式匹配的结果之后，进行样式的布局，*布局主要是针对元素的大小、形状发生改变的情况，这样的情况会影响网页的布局*。
4. 然后对于元素进行绘制，修改元素的颜色、边框等不影响布局的因素。
5. 最后是合成阶段，这个阶段将不同文档流的内容堆叠起来。

这五个阶段不一定是每个动画过程都需要经历的。

re-render的起点可能是CSS或者JavaScript，这是根据修改样式的方法确定的。

由于第三个布局阶段是由于元素的几何属性发生了变化导致的元素重排列，一般叫做回流，所以如果如果几何属性没有发生变化，那么会跳过这一个阶段。

如果只修改了例如背景、文字颜色、阴影等不改变布局的样式，那么不会产生回流，只会对当前样式进行重绘。

如果修改的属性既不需要布局，也不需要绘制，那么就直接执行合成阶段。如果想要实现抖动较小的动画，那么只进行合成阶段的更改是比较必要的。当前只影响合成阶段的属性有两个，`transform`和`opacity`属性。而`transform`属性通过各种变换可以实现很好的效果。

### 关键渲染路径

浏览器在进行页面渲染的时候，浏览器大致完成了这样的工作：

1. 处理HTML，并且通过HTML构建DOM树，
2. 处理CSS标记并且构建CSSOM树，
3. 根据上面的两棵树，将其合并成为渲染树，
4. 根据渲染树来进行布局，计算每个节点的布局信息，
5. 将各个节点绘制到屏幕上：栅格化。

对于渲染速度的优化，其实就是对关键渲染路径进行优化，一旦这五步的时间缩短了。那么渲染的速度就会加快。

在默认情况下，CSS被认为是阻塞渲染的资源，而渲染树的构建需要DOM树和CSSOM树同时准备完毕才可以。使用媒体查询可以让一些当前不需要的样式表延迟加载，使其不会阻塞渲染。

```html
<!-- 这个样式只有在打印的时候才会使用，所以是非阻塞的 -->
<link href="style.css" rel="stylesheet" media="print">
<!-- 这个样式是根据网页加载时候的设备方向，可能阻塞 -->
<link href="portrait.css" rel="stylesheet" media="orientation:portrait">
```

而对于JavaScript来说，也是默认阻塞DOM渲染的，尤其是外部的JavaScript文件，浏览器必须停下来，从磁盘或者网络中获取脚本，这样可能给关键渲染路径增加几十毫秒到几秒的延迟，默认情况下JavaScript都会阻止解析器。如果将脚本标记为异步，可以在等待脚本期间不阻止DOM构建。

